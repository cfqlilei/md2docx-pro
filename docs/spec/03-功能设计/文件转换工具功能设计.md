# 文件转换工具功能设计

## 1. 概述

本项目旨在开发一个简单的文件转换工具，实现将 Markdown 文件转换为 DOCX 格式文件的功能。

- 程序源代码路径：md2docx-src

**技术选型：**

- **用户界面 (UI)：** Qt 框架
- **后端逻辑 (Backend)：** Go 语言

## 2. 总体结构设计

应用程序主界面应采用标签页（Tab）结构，包含三个主要功能模块：

1.  单文件转换 (Single File Conversion)
2.  多文件转换 (Multiple Files Conversion)
3.  设置 (Configuration)

### 2.1. 前后端通信机制

- **技术栈：** 前端 Qt，后端 Go。
- **通信方式：** 前端通过进程间通信（IPC/RPC，例如 QProcess 调用 Go 可执行程序，或 gRPC/HTTP 服务）调用 Go 后端提供的转换服务接口，并接收转换状态和结果。

## 3. 单文件转换功能设计

该模块用于处理单个 Markdown 文件的转换。

### 3.1. 界面元素与交互

1.  **文件路径区域 (输入)：**
    - Markdown 文件路径框 (只读，显示路径)
    - 文件选择按钮 (触发文件选择对话框)
2.  **保存路径区域 (输出)：**
    - 保存路径框 (只读，显示目录)
    - 保存路径按钮 (触发目录选择对话框)
3.  **文件名区域 (输出)：**
    - 保存后文件名称框 (可编辑，用户输入文件名，不含后缀)
4.  **操作区：**
    - 转换按钮 (触发转换操作)
5.  **状态区域：**
    - 状态显示区域 (多行文本或日志窗口，显示操作反馈和错误信息)

### 3.2. 转换逻辑描述

#### 3.2.1. 输出路径确定

- 如果用户指定了保存路径，则使用该路径作为最终保存目录。
- 如果用户未指定保存路径，则默认使用原 Markdown 文件所在的目录作为保存目录。

#### 3.2.2. 输出文件名确定

- 如果用户在文件名称框中输入了名称，则转换后的文件名为 `{用户输入名称}.docx`。
- 如果文件名称框为空，则使用原 Markdown 文件的文件名（不含后缀），转换后的文件名为 `{原文件名}.docx`。

#### 3.2.3. 核心流程

1.  前端收集用户输入的 Markdown 文件路径、保存路径和保存文件名。
2.  前端调用 Go 后端接口，传递上述参数。
3.  后端根据 3.2.1 和 3.2.2 的规则确定最终的输出文件路径（包括文件名）。
4.  后端执行转换操作（例如使用 Pandoc 或其他 Go 库）。
5.  转换过程中，前端状态区域显示“转换中...”。
6.  转换成功后，前端状态区域显示“转换成功”。如果失败，显示具体的错误信息。

- **错误处理：**
  - 如果输入文件不存在或不可读，转换失败，状态区域显示错误信息。
  - 如果输出路径不可写，转换失败，状态区域显示错误信息。
  - 如果转换过程发生错误（如后端服务调用失败或 Pandoc 转换失败），转换失败，状态区域显示错误信息。

## 4. 多文件转换功能设计

该模块用于批量处理多个 Markdown 文件的转换。

### 4.1. 界面元素与交互

1.  **文件路径区域 (输入)：**
    - 文件路径多行文本框 (只读，显示所有选中的文件路径，每行一个)
    - 文件选择按钮 (触发多选文件对话框，支持追加)
2.  **保存路径区域 (输出)：**
    - 保存路径框 (只读，显示目录)
    - 保存路径按钮 (触发目录选择对话框)
3.  **操作区：**
    - 转换按钮 (触发批量转换操作)
4.  **状态区域：**
    - 状态显示区域 (多行文本或日志窗口，显示操作反馈、每个文件的转换进度和最终结果)

### 4.2. 转换逻辑描述

#### 4.2.1. 输出路径确定

- 如果用户指定了保存路径，则列表中的所有文件都将保存到该统一目录。
- 如果用户未指定保存路径，则每个转换后的 DOCX 文件将保存到其对应的原 Markdown 文件所在的目录。

#### 4.2.2. 输出文件名确定

- 所有转换后的文件，文件名默认与原 Markdown 文件名相同，后缀统一改为 `.docx`。

#### 4.2.3. 核心流程

1.  前端收集多行文本框中的 Markdown 文件路径列表，以及指定的保存路径。
2.  前端调用 Go 后端接口，传递文件列表和保存路径。
3.  后端遍历文件列表，对每个文件执行转换操作。
4.  对于每个文件，后端根据 4.2.1 和 4.2.2 的规则确定输出路径和文件名。
5.  转换过程中，前端状态区域显示当前正在处理的文件名和总体进度。
6.  所有文件转换成功后，前端状态区域显示“转换成功”。如果部分或全部失败，显示已完成和失败的文件列表及错误信息。

- **错误处理：**
  - 批量转换应采用健壮的机制，单个文件的转换失败不应中断整个批次。
  - 状态区域应清晰地记录并显示所有成功和失败的文件列表，以及失败的具体原因。
  - 如果输出路径不可写，应在开始批量转换前进行检查，并提示用户。

## 5. 设置功能设计 (Configuration)

该模块提供应用程序级别的配置，主要用于管理 Pandoc 依赖和转换参数。

### 5.1. 界面元素与交互

1.  **Pandoc 路径配置：**
    - 输入框：显示当前 Pandoc 可执行文件的路径。
    - 选择按钮：允许用户浏览并选择 Pandoc 可执行文件。
    - 按钮：重置为默认路径。
2.  **参考模板配置：**
    - 输入框：显示当前参考 DOCX 模板文件的路径。
    - 选择按钮：允许用户浏览并选择 DOCX 模板文件。
    - 按钮：重置为默认模板路径。

### 5.2. 转换依赖逻辑

#### 5.2.1. Pandoc 路径确定

- **指定路径：** 优先使用用户在设置中指定的 Pandoc 路径。
- **默认路径：** 如果用户未指定，尝试在系统环境变量 PATH 中查找 Pandoc 可执行文件。
- **转换检查：** 在每次执行转换操作前，系统必须检查 Pandoc 路径是否有效：
  - 如果 Pandoc 未安装或路径无效，则停止转换，并在状态区域提示用户安装或配置正确的路径。

#### 5.2.2. 参考模板确定

- **指定模板：** 优先使用用户在设置中指定的参考模板路径。
- **默认模板：** 如果用户未指定，系统使用内置的默认模板（或不使用参考模板，取决于实现）。
- **命令行参数：** 转换时，后端使用如下命令结构（如果参考模板路径有效）：
  `pandoc <输入 Markdown 文件> -o <输出 Word 文件.docx> --reference-doc="<转换参考模板路径>"`
