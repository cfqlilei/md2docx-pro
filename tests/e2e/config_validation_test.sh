#!/bin/bash

# é…ç½®éªŒè¯åŠŸèƒ½æ”¹è¿›æµ‹è¯•
# æµ‹è¯•è®¾ç½®é¡µé¢çš„é…ç½®éªŒè¯æ˜¯å¦æä¾›è¯¦ç»†çš„éªŒè¯ç»“æžœåé¦ˆ

set -e

# æµ‹è¯•é…ç½®
TEST_NAME="é…ç½®éªŒè¯åŠŸèƒ½æ”¹è¿›æµ‹è¯•"
TEST_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$TEST_DIR/../.." && pwd)"
RESULTS_DIR="$PROJECT_ROOT/tests/results"

# åˆ›å»ºç»“æžœç›®å½•
mkdir -p "$RESULTS_DIR"

# æ—¥å¿—å‡½æ•°
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$RESULTS_DIR/config_validation_test.log"
}

log "å¼€å§‹æ‰§è¡Œ $TEST_NAME"

# æ£€æŸ¥åŽç«¯APIæ”¹è¿›
log "æ£€æŸ¥åŽç«¯é…ç½®éªŒè¯APIæ”¹è¿›..."

HANDLERS_GO="$PROJECT_ROOT/internal/api/handlers.go"

if [ ! -f "$HANDLERS_GO" ]; then
    log "âŒ æœªæ‰¾åˆ°handlers.goæ–‡ä»¶"
    exit 1
fi

# æ£€æŸ¥è¯¦ç»†éªŒè¯é€»è¾‘
if grep -q "validationMessages.*\[\]string" "$HANDLERS_GO"; then
    log "âœ… åŽç«¯ä½¿ç”¨è¯¦ç»†éªŒè¯æ¶ˆæ¯æ•°ç»„"
else
    log "âŒ åŽç«¯æœªä½¿ç”¨è¯¦ç»†éªŒè¯æ¶ˆæ¯æ•°ç»„"
fi

if grep -q "Pandocè·¯å¾„éªŒè¯" "$HANDLERS_GO"; then
    log "âœ… åŽç«¯åŒ…å«Pandocè·¯å¾„éªŒè¯æ¶ˆæ¯"
else
    log "âŒ åŽç«¯ç¼ºå°‘Pandocè·¯å¾„éªŒè¯æ¶ˆæ¯"
fi

if grep -q "æ¨¡æ¿æ–‡ä»¶éªŒè¯" "$HANDLERS_GO"; then
    log "âœ… åŽç«¯åŒ…å«æ¨¡æ¿æ–‡ä»¶éªŒè¯æ¶ˆæ¯"
else
    log "âŒ åŽç«¯ç¼ºå°‘æ¨¡æ¿æ–‡ä»¶éªŒè¯æ¶ˆæ¯"
fi

if grep -q "æœªé…ç½®æ¨¡æ¿æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰" "$HANDLERS_GO"; then
    log "âœ… åŽç«¯æ­£ç¡®å¤„ç†å¯é€‰æ¨¡æ¿æ–‡ä»¶"
else
    log "âŒ åŽç«¯æœªæ­£ç¡®å¤„ç†å¯é€‰æ¨¡æ¿æ–‡ä»¶"
fi

# æ£€æŸ¥å‰ç«¯æ”¹è¿›
log "æ£€æŸ¥å‰ç«¯é…ç½®éªŒè¯æ˜¾ç¤ºæ”¹è¿›..."

SETTINGS_CPP="$PROJECT_ROOT/qt-frontend/src/settingswidget.cpp"

if [ ! -f "$SETTINGS_CPP" ]; then
    log "âŒ æœªæ‰¾åˆ°settingswidget.cppæ–‡ä»¶"
    exit 1
fi

# æ£€æŸ¥è¯¦ç»†éªŒè¯ç»“æžœæ˜¾ç¤º
if grep -q "split.*'\\\\n'" "$SETTINGS_CPP"; then
    log "âœ… å‰ç«¯è§£æžå¤šè¡ŒéªŒè¯ç»“æžœ"
else
    log "âŒ å‰ç«¯æœªè§£æžå¤šè¡ŒéªŒè¯ç»“æžœ"
fi

if grep -q "é…ç½®éªŒè¯é€šè¿‡" "$SETTINGS_CPP"; then
    log "âœ… å‰ç«¯æ˜¾ç¤ºéªŒè¯é€šè¿‡æ¶ˆæ¯"
else
    log "âŒ å‰ç«¯æœªæ˜¾ç¤ºéªŒè¯é€šè¿‡æ¶ˆæ¯"
fi

if grep -q "é…ç½®éªŒè¯å¤±è´¥" "$SETTINGS_CPP"; then
    log "âœ… å‰ç«¯æ˜¾ç¤ºéªŒè¯å¤±è´¥æ¶ˆæ¯"
else
    log "âŒ å‰ç«¯æœªæ˜¾ç¤ºéªŒè¯å¤±è´¥æ¶ˆæ¯"
fi

# å¯åŠ¨åŽç«¯æœåŠ¡è¿›è¡ŒAPIæµ‹è¯•
log "å¯åŠ¨åŽç«¯æœåŠ¡è¿›è¡ŒAPIæµ‹è¯•..."

# æ£€æŸ¥æ˜¯å¦æœ‰åŽç«¯å¯æ‰§è¡Œæ–‡ä»¶
BACKEND_BINARY=""
if [ -f "$PROJECT_ROOT/build/md2docx-server-macos" ]; then
    BACKEND_BINARY="$PROJECT_ROOT/build/md2docx-server-macos"
elif [ -f "$PROJECT_ROOT/md2docx-server" ]; then
    BACKEND_BINARY="$PROJECT_ROOT/md2docx-server"
else
    log "âš ï¸  æœªæ‰¾åˆ°åŽç«¯å¯æ‰§è¡Œæ–‡ä»¶ï¼Œè·³è¿‡APIæµ‹è¯•"
fi

if [ -n "$BACKEND_BINARY" ]; then
    log "âœ… æ‰¾åˆ°åŽç«¯å¯æ‰§è¡Œæ–‡ä»¶: $BACKEND_BINARY"
    
    # å¯åŠ¨åŽç«¯æœåŠ¡
    "$BACKEND_BINARY" &
    BACKEND_PID=$!
    
    # ç­‰å¾…æœåŠ¡å¯åŠ¨
    sleep 3
    
    # æµ‹è¯•é…ç½®éªŒè¯API
    log "æµ‹è¯•é…ç½®éªŒè¯API..."
    
    # æµ‹è¯•1ï¼šéªŒè¯ä¸å­˜åœ¨çš„Pandocè·¯å¾„
    log "æµ‹è¯•1ï¼šéªŒè¯ä¸å­˜åœ¨çš„Pandocè·¯å¾„"
    
    # é¦–å…ˆè®¾ç½®ä¸€ä¸ªæ— æ•ˆçš„é…ç½®
    curl -s -X POST http://localhost:8080/api/config \
        -H "Content-Type: application/json" \
        -d '{"pandoc_path": "/nonexistent/pandoc", "template_file": ""}' \
        > /dev/null 2>&1
    
    # ç„¶åŽéªŒè¯é…ç½®
    VALIDATION_RESULT=$(curl -s -X POST http://localhost:8080/api/config/validate)
    
    if echo "$VALIDATION_RESULT" | grep -q "Pandocè·¯å¾„éªŒè¯å¤±è´¥"; then
        log "âœ… APIæ­£ç¡®è¿”å›žPandocè·¯å¾„éªŒè¯å¤±è´¥æ¶ˆæ¯"
    else
        log "âŒ APIæœªè¿”å›žé¢„æœŸçš„Pandocè·¯å¾„éªŒè¯å¤±è´¥æ¶ˆæ¯"
        log "å®žé™…è¿”å›ž: $VALIDATION_RESULT"
    fi
    
    if echo "$VALIDATION_RESULT" | grep -q "æœªé…ç½®æ¨¡æ¿æ–‡ä»¶"; then
        log "âœ… APIæ­£ç¡®è¿”å›žæ¨¡æ¿æ–‡ä»¶æœªé…ç½®æ¶ˆæ¯"
    else
        log "âŒ APIæœªè¿”å›žé¢„æœŸçš„æ¨¡æ¿æ–‡ä»¶æœªé…ç½®æ¶ˆæ¯"
    fi
    
    # æµ‹è¯•2ï¼šéªŒè¯æ— æ•ˆçš„æ¨¡æ¿æ–‡ä»¶
    log "æµ‹è¯•2ï¼šéªŒè¯æ— æ•ˆçš„æ¨¡æ¿æ–‡ä»¶"
    
    curl -s -X POST http://localhost:8080/api/config \
        -H "Content-Type: application/json" \
        -d '{"pandoc_path": "/usr/local/bin/pandoc", "template_file": "/nonexistent/template.docx"}' \
        > /dev/null 2>&1
    
    VALIDATION_RESULT=$(curl -s -X POST http://localhost:8080/api/config/validate)
    
    if echo "$VALIDATION_RESULT" | grep -q "æ¨¡æ¿æ–‡ä»¶éªŒè¯å¤±è´¥"; then
        log "âœ… APIæ­£ç¡®è¿”å›žæ¨¡æ¿æ–‡ä»¶éªŒè¯å¤±è´¥æ¶ˆæ¯"
    else
        log "âŒ APIæœªè¿”å›žé¢„æœŸçš„æ¨¡æ¿æ–‡ä»¶éªŒè¯å¤±è´¥æ¶ˆæ¯"
        log "å®žé™…è¿”å›ž: $VALIDATION_RESULT"
    fi
    
    # å…³é—­åŽç«¯æœåŠ¡
    kill $BACKEND_PID 2>/dev/null || true
    wait $BACKEND_PID 2>/dev/null || true
    
    log "âœ… APIæµ‹è¯•å®Œæˆ"
fi

# åˆ›å»ºæµ‹è¯•è¯´æ˜Žæ–‡æ¡£
cat > "$RESULTS_DIR/config_validation_test_instructions.md" << 'EOF'
# é…ç½®éªŒè¯åŠŸèƒ½æ”¹è¿›æµ‹è¯•è¯´æ˜Ž

## æµ‹è¯•ç›®æ ‡
éªŒè¯è®¾ç½®é¡µé¢çš„é…ç½®éªŒè¯åŠŸèƒ½æ”¹è¿›ï¼ŒåŒ…æ‹¬ï¼š
1. åˆ†åˆ«éªŒè¯Pandocè·¯å¾„å’Œæ¨¡æ¿æ–‡ä»¶è·¯å¾„
2. æä¾›è¯¦ç»†çš„éªŒè¯ç»“æžœåé¦ˆ
3. ä½¿ç”¨æ¸…æ™°çš„æˆåŠŸ/å¤±è´¥æŒ‡ç¤º

## æ‰‹åŠ¨æµ‹è¯•æ­¥éª¤

### æ­¥éª¤1ï¼šæµ‹è¯•Pandocè·¯å¾„éªŒè¯

#### æµ‹è¯•åœºæ™¯1ï¼šæœ‰æ•ˆçš„Pandocè·¯å¾„
1. å¯åŠ¨åº”ç”¨ç¨‹åº
2. åˆ‡æ¢åˆ°"è®¾ç½®"æ ‡ç­¾é¡µ
3. åœ¨Pandocè·¯å¾„ä¸­è¾“å…¥æœ‰æ•ˆè·¯å¾„ï¼ˆå¦‚ï¼š/usr/local/bin/pandocï¼‰
4. ç‚¹å‡»"éªŒè¯é…ç½®"æŒ‰é’®
5. è§‚å¯ŸéªŒè¯ç»“æžœ

**é¢„æœŸç»“æžœï¼š**
- æ˜¾ç¤º `âœ… Pandocè·¯å¾„éªŒè¯æˆåŠŸ`
- å¦‚æžœæœªé…ç½®æ¨¡æ¿æ–‡ä»¶ï¼Œæ˜¾ç¤º `â„¹ï¸ æœªé…ç½®æ¨¡æ¿æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰`

#### æµ‹è¯•åœºæ™¯2ï¼šæ— æ•ˆçš„Pandocè·¯å¾„
1. åœ¨Pandocè·¯å¾„ä¸­è¾“å…¥æ— æ•ˆè·¯å¾„ï¼ˆå¦‚ï¼š/nonexistent/pandocï¼‰
2. ç‚¹å‡»"éªŒè¯é…ç½®"æŒ‰é’®
3. è§‚å¯ŸéªŒè¯ç»“æžœ

**é¢„æœŸç»“æžœï¼š**
- æ˜¾ç¤º `âŒ Pandocè·¯å¾„éªŒè¯å¤±è´¥: [å…·ä½“é”™è¯¯ä¿¡æ¯]`
- æ˜¾ç¤º `â„¹ï¸ æœªé…ç½®æ¨¡æ¿æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰`

#### æµ‹è¯•åœºæ™¯3ï¼šç©ºçš„Pandocè·¯å¾„
1. æ¸…ç©ºPandocè·¯å¾„
2. ç‚¹å‡»"éªŒè¯é…ç½®"æŒ‰é’®
3. è§‚å¯ŸéªŒè¯ç»“æžœ

**é¢„æœŸç»“æžœï¼š**
- æ˜¾ç¤º `âŒ Pandocè·¯å¾„éªŒè¯å¤±è´¥: Pandocè·¯å¾„æœªé…ç½®`

### æ­¥éª¤2ï¼šæµ‹è¯•æ¨¡æ¿æ–‡ä»¶éªŒè¯

#### æµ‹è¯•åœºæ™¯4ï¼šæœ‰æ•ˆçš„Pandocè·¯å¾„ + æœ‰æ•ˆçš„æ¨¡æ¿æ–‡ä»¶
1. è®¾ç½®æœ‰æ•ˆçš„Pandocè·¯å¾„
2. å‹¾é€‰"ä½¿ç”¨è‡ªå®šä¹‰æ¨¡æ¿"
3. é€‰æ‹©ä¸€ä¸ªå­˜åœ¨çš„.docxæ–‡ä»¶ä½œä¸ºæ¨¡æ¿
4. ç‚¹å‡»"éªŒè¯é…ç½®"æŒ‰é’®

**é¢„æœŸç»“æžœï¼š**
- æ˜¾ç¤º `âœ… Pandocè·¯å¾„éªŒè¯æˆåŠŸ`
- æ˜¾ç¤º `âœ… æ¨¡æ¿æ–‡ä»¶éªŒè¯æˆåŠŸ`

#### æµ‹è¯•åœºæ™¯5ï¼šæœ‰æ•ˆçš„Pandocè·¯å¾„ + æ— æ•ˆçš„æ¨¡æ¿æ–‡ä»¶
1. è®¾ç½®æœ‰æ•ˆçš„Pandocè·¯å¾„
2. å‹¾é€‰"ä½¿ç”¨è‡ªå®šä¹‰æ¨¡æ¿"
3. åœ¨æ¨¡æ¿æ–‡ä»¶è·¯å¾„ä¸­è¾“å…¥ä¸å­˜åœ¨çš„æ–‡ä»¶è·¯å¾„
4. ç‚¹å‡»"éªŒè¯é…ç½®"æŒ‰é’®

**é¢„æœŸç»“æžœï¼š**
- æ˜¾ç¤º `âœ… Pandocè·¯å¾„éªŒè¯æˆåŠŸ`
- æ˜¾ç¤º `âŒ æ¨¡æ¿æ–‡ä»¶éªŒè¯å¤±è´¥: [å…·ä½“é”™è¯¯ä¿¡æ¯]`

#### æµ‹è¯•åœºæ™¯6ï¼šé”™è¯¯çš„æ¨¡æ¿æ–‡ä»¶æ ¼å¼
1. è®¾ç½®æœ‰æ•ˆçš„Pandocè·¯å¾„
2. å‹¾é€‰"ä½¿ç”¨è‡ªå®šä¹‰æ¨¡æ¿"
3. é€‰æ‹©ä¸€ä¸ªéž.docxæ–‡ä»¶ï¼ˆå¦‚.txtæ–‡ä»¶ï¼‰
4. ç‚¹å‡»"éªŒè¯é…ç½®"æŒ‰é’®

**é¢„æœŸç»“æžœï¼š**
- æ˜¾ç¤º `âœ… Pandocè·¯å¾„éªŒè¯æˆåŠŸ`
- æ˜¾ç¤º `âŒ æ¨¡æ¿æ–‡ä»¶éªŒè¯å¤±è´¥: æ¨¡æ¿æ–‡ä»¶å¿…é¡»æ˜¯.docxæ ¼å¼`

### æ­¥éª¤3ï¼šéªŒè¯æ˜¾ç¤ºæ•ˆæžœæ”¹è¿›

æ£€æŸ¥ä»¥ä¸‹æ˜¾ç¤ºæ•ˆæžœï¼š
- [ ] éªŒè¯ç»“æžœä½¿ç”¨ä¸åŒé¢œè‰²åŒºåˆ†æˆåŠŸ/å¤±è´¥/ä¿¡æ¯
- [ ] æˆåŠŸæ¶ˆæ¯ä½¿ç”¨ç»¿è‰²å’Œâœ…å›¾æ ‡
- [ ] å¤±è´¥æ¶ˆæ¯ä½¿ç”¨çº¢è‰²å’ŒâŒå›¾æ ‡
- [ ] ä¿¡æ¯æ¶ˆæ¯ä½¿ç”¨è“è‰²å’Œâ„¹ï¸å›¾æ ‡
- [ ] æ¶ˆæ¯æ ¼å¼æ¸…æ™°æ˜“è¯»
- [ ] æ—¶é—´æˆ³æ­£ç¡®æ˜¾ç¤º

## é¢„æœŸç»“æžœæ€»ç»“
- é…ç½®éªŒè¯åº”è¯¥åˆ†åˆ«æ£€æŸ¥Pandocè·¯å¾„å’Œæ¨¡æ¿æ–‡ä»¶
- æ¯ä¸ªç»„ä»¶çš„éªŒè¯ç»“æžœåº”è¯¥å•ç‹¬æ˜¾ç¤º
- ä½¿ç”¨æ¸…æ™°çš„å›¾æ ‡å’Œé¢œè‰²åŒºåˆ†ä¸åŒç±»åž‹çš„æ¶ˆæ¯
- æä¾›å…·ä½“çš„é”™è¯¯ä¿¡æ¯å¸®åŠ©ç”¨æˆ·è§£å†³é—®é¢˜
- æ¨¡æ¿æ–‡ä»¶éªŒè¯åº”è¯¥æ­£ç¡®å¤„ç†å¯é€‰æ€§ï¼ˆæœªé…ç½®æ—¶ä¸æŠ¥é”™ï¼‰

## å›žå½’æµ‹è¯•
ç¡®ä¿æ”¹è¿›ä¸ä¼šå½±å“åŽŸæœ‰åŠŸèƒ½ï¼š
- [ ] é…ç½®ä¿å­˜åŠŸèƒ½æ­£å¸¸
- [ ] é…ç½®åŠ è½½åŠŸèƒ½æ­£å¸¸
- [ ] Pandocè·¯å¾„æ£€æµ‹åŠŸèƒ½æ­£å¸¸
- [ ] æ¨¡æ¿æ–‡ä»¶é€‰æ‹©åŠŸèƒ½æ­£å¸¸
EOF

log "âœ… ç”Ÿæˆæµ‹è¯•è¯´æ˜Žæ–‡æ¡£"

# ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
cat > "$RESULTS_DIR/config_validation_test_report.md" << EOF
# é…ç½®éªŒè¯åŠŸèƒ½æ”¹è¿›æµ‹è¯•æŠ¥å‘Š

## æµ‹è¯•æ—¶é—´
$(date '+%Y-%m-%d %H:%M:%S')

## åŽç«¯APIæ£€æŸ¥ç»“æžœ
- è¯¦ç»†éªŒè¯æ¶ˆæ¯æ•°ç»„: $(grep -q "validationMessages.*\[\]string" "$HANDLERS_GO" && echo "âœ… é€šè¿‡" || echo "âŒ å¤±è´¥")
- Pandocè·¯å¾„éªŒè¯æ¶ˆæ¯: $(grep -q "Pandocè·¯å¾„éªŒè¯" "$HANDLERS_GO" && echo "âœ… é€šè¿‡" || echo "âŒ å¤±è´¥")
- æ¨¡æ¿æ–‡ä»¶éªŒè¯æ¶ˆæ¯: $(grep -q "æ¨¡æ¿æ–‡ä»¶éªŒè¯" "$HANDLERS_GO" && echo "âœ… é€šè¿‡" || echo "âŒ å¤±è´¥")
- å¯é€‰æ¨¡æ¿æ–‡ä»¶å¤„ç†: $(grep -q "æœªé…ç½®æ¨¡æ¿æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰" "$HANDLERS_GO" && echo "âœ… é€šè¿‡" || echo "âŒ å¤±è´¥")

## å‰ç«¯æ˜¾ç¤ºæ£€æŸ¥ç»“æžœ
- å¤šè¡Œç»“æžœè§£æž: $(grep -q "split.*'\\\\n'" "$SETTINGS_CPP" && echo "âœ… é€šè¿‡" || echo "âŒ å¤±è´¥")
- éªŒè¯é€šè¿‡æ¶ˆæ¯: $(grep -q "é…ç½®éªŒè¯é€šè¿‡" "$SETTINGS_CPP" && echo "âœ… é€šè¿‡" || echo "âŒ å¤±è´¥")
- éªŒè¯å¤±è´¥æ¶ˆæ¯: $(grep -q "é…ç½®éªŒè¯å¤±è´¥" "$SETTINGS_CPP" && echo "âœ… é€šè¿‡" || echo "âŒ å¤±è´¥")

## APIæµ‹è¯•ç»“æžœ
$(if [ -n "$BACKEND_BINARY" ]; then echo "- åŽç«¯æœåŠ¡å¯ç”¨: âœ… é€šè¿‡"; else echo "- åŽç«¯æœåŠ¡å¯ç”¨: âš ï¸  è·³è¿‡"; fi)

## æµ‹è¯•æ–‡ä»¶
- æµ‹è¯•è¯´æ˜Žæ–‡æ¡£: $RESULTS_DIR/config_validation_test_instructions.md

## ä¸‹ä¸€æ­¥
è¯·æŒ‰ç…§æµ‹è¯•è¯´æ˜Žæ–‡æ¡£è¿›è¡Œè¯¦ç»†çš„æ‰‹åŠ¨æµ‹è¯•ä»¥éªŒè¯æ‰€æœ‰æ”¹è¿›åŠŸèƒ½ã€‚
EOF

log "âœ… $TEST_NAME å®Œæˆ"
log "ðŸ“‹ è¯·æŸ¥çœ‹ $RESULTS_DIR/config_validation_test_instructions.md è¿›è¡Œæ‰‹åŠ¨æµ‹è¯•"
log "ðŸ“Š æµ‹è¯•æŠ¥å‘Š: $RESULTS_DIR/config_validation_test_report.md"
